<?xml version="1.0" encoding="UTF-8" ?>
<Module>
  <ModulePrefs title="Kaltura Wave"
               height="310"
               author="papyromancer"
               author_email="papyromancer@lightcorp.net">
    <Require feature="wave" />
    <Require feature="locked-domain" />
    <Require feature="dynamic-height" />
    <Require feature="flash" />
  </ModulePrefs>
  <Content type="html">
    <![CDATA[
      <div id="kaltura-wave">
        <div id="kcontribute" style="text-align:center""></div>
        <div id="kplayer" style="text-align:center"></div>
        <div id="kedit" style="text-align:center""></div>
      </div>
      
      <script type="text/javascript" src="js/jquery-1.2.6.min.js"></script>
      <script type="text/javascript" src="http://wave-api.appspot.com/public/wave.js"></script>

      <script type="text/javascript">
        // Init!
        function initialize() {
          // Make wave state aware
            if (wave && wave.isInWaveContainer()) {
/              wave.setStateCallback(receiveState, this);
/              wave.setParticipantCallback(receiveWaveParticipants, this);
/              wave.setModeCallback(receiveMode, this);
            };
        };

        function receiveState(state) {
          wave.log("Got state: " + gadgets.json.stringify(state));
          gadgets.window.adjustHeight();
        };

        function receiveWaveParticipants(participants) {
          var str = '';
          var name = "unknown";
          if (wave.getViewer()) {
            name = wave.getViewer().getDisplayName();
          };
          str += 'I am ' + name + '<br/>';
          str += 'Participants:' + '<br/>';
          for (var i in participants) {
            str += '&nbsp;&nbsp;&nbsp;' + participants[i].getDisplayName() + '<br/>';
          };
          gadgets.window.adjustHeight();
        };

        function receiveMode(mode) {
          var modeStr = "UNKNOWN";
          switch (mode) {
            case wave.Mode.PLAYBACK: modeStr = "PLAYBACK"; break;
            case wave.Mode.EDIT: modeStr = "EDIT"; break;
            case wave.Mode.VIEW: modeStr = "VIEW"; break;
          }
          var disableButtons = !(mode == wave.Mode.EDIT);
        };

        function updateState() {
          var state = wave.getState();
          var participants = wave.getParticipants();
          var entry_id = state.get('entry_id');
          if !entry_id {
            //video has not been chosen!
          }
          if ((typeof entry_id == 'string') && (entry_id) {
            wavePlay(entry_id);
          } else {
            //video has not been chosen
          }
          state.submitDelta({'entry_id' : entry_id });
        }

        // Function to select a video to insert into the player
        function waveContribute() {
          
          // Set Variables for kcontribute
          var kvars = {
                      //entry_id: entry_id "knrwbq7z4o"
                      };
          
          // kflashvars should be constructed from the kvars object
          var kflashvars = "entry_id="+entry_id // knrwbq7z4o"
          
          var kparams = {
                        allowscriptaccess: "always",
                        allownetworking: "all",
                        allowfullscreen: "true",
                        wmode: "opaque",
                        width: "400",
                        height: "290"
                        };

          gadgets.flash.embedFlash("http://www.kaltura.com/kcw/ui_conf_id/1000741 "+kflashvars, "kplayer", "9.0.0", kparams );
        };

        // Function to populate kplayer with current video
        function wavePlay(entry_id) {
        
          // Set Variables for kplayer
          var kvars = {
                      entry_id: entry_id //"knrwbq7z4o"
                      };
          
          // kflashvars should be constructed from the kvars object
          var kflashvars = "entry_id="+entry_id // knrwbq7z4o"
          
          var kparams = {
                        allowscriptaccess: "always",
                        allownetworking: "all",
                        allowfullscreen: "true",
                        wmode: "opaque",
                        width: "400",
                        height: "290"
                        };
          // embed kplayer
          gadgets.flash.embedFlash("http://www.kaltura.com/kwidget/wid/_39061/ui_conf_id/1008311?"+kflashvars, "kplayer", "9.0.0", kparams );
        };
        
        // Call init function
        gadgets.util.registerOnLoadHandler(initialize);

wavePlay("knrwbq7z4o")

        </script>
    ]]>
  </Content>
</Module>
